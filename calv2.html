<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>g-calendar test</title>
    <style>
    *{
        margin:0;
        padding:0;
        font-size: 18px;
        line-height: 24px;
        font-family: sans-serif;
    }
    *{position: relative;box-sizing: border-box;}
    table,tr,tbody,thead,td,th{border-collapse: collapse;}
    td{
        width:8rem;
        height:8rem;
        border:1px solid rgba(0,0,0,.1);
        vertical-align: top;
        padding:1rem;
      }
      #authorize-div{
        background:rgba(0,100,255,.5);
        padding:5rem;
      }
        #authorized{display:block;}
        label,input,button{display: block;}
        .wrap{
            width: 80%;
            margin: 5rem auto;
        }
        .cal-event{
            padding:.5rem;
        }
        .cal-event p,.cal-event br{
            font-size: 14px;
            line-height: 18px;
        }
    </style>

 <script type="text/javascript">
    // Your Client ID can be retrieved from your project in the Google
    // Developer Console, https://console.developers.google.com
    var CLIENT_ID = '781532624008-amifuh5lt04sdbba90gojoq2tr656rse.apps.googleusercontent.com';

    var SCOPES = ["https://www.googleapis.com/auth/calendar.readonly"];

    /**
     * Check if current user has authorized this application.
     */
    function checkAuth() {
      gapi.auth.authorize(
        {
          'client_id': CLIENT_ID,
          'scope': SCOPES.join(' '),
          'immediate': true
        }, handleAuthResult);
    }

    /** Handle response from authorization server.*/
    function handleAuthResult(authResult) {
      var authorizeDiv = document.getElementById('authorize-div');
      var authorizedDiv = document.getElementById('authorized');
      if (authResult && !authResult.error) {
        // Hide auth UI, then load client library.
        console.log("app has been authorized");
        authorizeDiv.style.display = 'none';
        authorizedDiv.style.display = 'block';
        //TODO get value of user calID
        var calYear = parseInt(document.getElementById('cal-year').value);
        var calMonth = parseInt(document.getElementById('cal-month').value);
        var calID = 'dmail.dixie.edu_o8rcipn2b5um5tc9b1ssjuo0mo@group.calendar.google.com';
        loadCalendarApi(calID,calMonth,calYear);
      } else {
        // Show auth UI, allowing the user to initiate authorization by
        // clicking authorize button.
        authorizeDiv.style.display = 'inline';
        console.log("not authorized");
      }
    }

    /** Initiate auth flow in response to user clicking authorize button.*/
    function handleAuthClick(event) {
      gapi.auth.authorize(
        {client_id: CLIENT_ID, scope: SCOPES, immediate: false},
        handleAuthResult);
      return false;
    }

    /**
     * Load Google Calendar client library. & calls getEvents when loaded*/
    function loadCalendarApi(calID,calMonth,calYear) {
      console.log("begin api load");
      gapi.client.load('calendar', 'v3', getEvents(calID,calMonth,calYear));
    }

    /**makes the request and returns events for specified date range*/
    function getEvents(calID,calMonth,calYear) {
      return function(){
        console.log("getEvents runs");
        var test = new Date(calYear,parseInt(calMonth)+1,0,23,59,59);
        var request = gapi.client.calendar.events.list({
            'calendarId': calID,
            'timeMin': (new Date(calYear,calMonth,1,0,0,0)).toISOString(),
            'timeMax': (new Date(calYear,parseInt(calMonth)+1,0,23,59,59)).toISOString(),
            'showDeleted': false,
            'singleEvents': true,
            'maxResults': 1000,
            'orderBy': 'startTime'
        });//end request definition

        request.then(
            function (resp) {
                var calYear = parseInt(document.getElementById('cal-year').value);
                var calMonth = parseInt(document.getElementById('cal-month').value);
                var events = JSON.parse(resp.body);
                events = events["items"];
                console.log("number of events: "+events.length);
                if (events.length > 0) {
                    var calDays = document.getElementsByClassName('cal-day');
                    var calDates=[];
                    for (var i=0; i<calDays.length; i++){
                        calDates[i] = calDays[i].textContent;
                        console.log("date in box: "+calDates[i]);
                        for (var j=0; j<events.length; j++){
                            var event =  events[j];
                            var when = event.start.dateTime;
                            if (!when) {
                                when = event.start.date;
                            }
                            var when = new Date(Date.parse(when));
                            if(when.getDate() == calDates[i]){
                                //add event to calendar
                                var eventTime = when.toLocaleTimeString('en-US', { hour12: true,  hour:"numeric",minute:"2-digit" });
                                var calEvent = document.createElement('div');
                                calEvent.setAttribute('class','cal-event')
                                console.log(calEvent);
                                calEvent.innerHTML =  '<p>' + event.summary + '<br> @' + eventTime + '</p>';

                                calDays[i].appendChild(calEvent);
                            }
                        }//for each event in list
                    }//for each day in calendar
                }//ends if there's events
                else {
                    alert('No upcoming events found.');
                }//end if/else for if returned events
            }, //end success function
        function(){alert("failed!");}
        ); //ends then function
      };//ends anon return function
    }//ends getEvents



    //builds the base calendar for selected month, or today if none is provided
    function buildCalendar(){
        var calYear = document.getElementById('cal-year').value;
        var calMonth = document.getElementById('cal-month').value;
        var monthArray =  {'01':'January', '02':'February','04':'March','05':'April','06':'June','07':'July','08':'August','09':'September','10':'October','11':'November','0':'December'};
        var calDays = document.getElementsByClassName('cal-day');
        var dayOne = new Date(calYear,calMonth,1);
        var lastDay = new Date(calYear,calMonth+1,0);
        var count = 0;
        for (var i = dayOne.getDay(); i<lastDay+1; i++){
            count+=1;
            calDays[i].innerHTML = count;
        }//loop over days from starting day of week to end of month

        var dayOne = new Date(year,month,1);
        var lastDay = new Date(year,parseInt(month)+1,0);
        var count = 0;
        for (var i = dayOne.getDay(); i<parseInt(lastDay.getDate())+1; i++){
            count+=1;
            //FIXME day is not appending to node
            calDays[i].textContent = count;
        }//loop over days from starting day of week to end of month
    }//end buildCalendar

  </script>
  <script src="https://apis.google.com/js/client.js?onload=checkAuth">
  </script>
</head>
</head>
<body>
    <div id="authorize-div" class="wrap">
        <label for="g-id">What is the CalendarID of the calendar you want to share?</label>
        <input type="text" placeholder="google calendar ID" id="g-id"/>
        <label for="authorize-button">Authorize access to Google Calendar API</label>
        <!--Button for the user to click to initiate auth sequence -->
        <button id="authorize-button" onclick="handleAuthClick(event)">
          Authorize
        </button>
    </div>
    <div id="authorized" class="wrap">
        <select name="month" id="cal-month">
            <option value="0">January</option>
            <option value="1">February</option>
            <option value="2">March</option>
            <option value="3">April</option>
            <option value="4">May</option>
            <option value="5">June</option>
            <option value="6">July</option>
            <option value="7">August</option>
            <option value="8">September</option>
            <option value="9">October</option>
            <option value="10">November</option>
            <option value="11">December</option>
        </select>
        <select name="year" id="cal-year">
            <option value="2012">2012</option>
            <option value="2013">2013</option>
            <option value="2014">2014</option>
            <option value="2015">2015</option>
            <option value="2016">2016</option>
            <option value="2017">2017</option>
            <option value="2018">2018</option>
            <option value="2019">2019</option>
            <option value="2020">2020</option>
            <option value="2021">2021</option>
        </select>
        <!--TODO create drop downs to select month and year - prefilled with today's values -->
        <table>
        <thead>
          <tr>
            <th>Sunday</th>
            <th>Monday</th>
            <th>Tuesday</th>
            <th>Wednesday</th>
            <th>Thursday</th>
            <th>Friday</th>
            <th>Saturday</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td class="cal-day sun"></td>
            <td class="cal-day mon"></td>
            <td class="cal-day tues"></td>
            <td class="cal-day wed"></td>
            <td class="cal-day thurs"></td>
            <td class="cal-day fri"></td>
            <td class="cal-day sat"></td>
          </tr>
          <tr>
            <td class="cal-day sun"></td>
            <td class="cal-day mon"></td>
            <td class="cal-day tues"></td>
            <td class="cal-day wed"></td>
            <td class="cal-day thurs"></td>
            <td class="cal-day fri"></td>
            <td class="cal-day sat"></td>
          </tr>
          <tr>
            <td class="cal-day sun"></td>
            <td class="cal-day mon"></td>
            <td class="cal-day tues"></td>
            <td class="cal-day wed"></td>
            <td class="cal-day thurs"></td>
            <td class="cal-day fri"></td>
            <td class="cal-day sat"></td>
          </tr>
          <tr>
            <td class="cal-day sun"></td>
            <td class="cal-day mon"></td>
            <td class="cal-day tues"></td>
            <td class="cal-day wed"></td>
            <td class="cal-day thurs"></td>
            <td class="cal-day fri"></td>
            <td class="cal-day sat"></td>
          </tr>
          <tr>
            <td class="cal-day sun"></td>
            <td class="cal-day mon"></td>
            <td class="cal-day tues"></td>
            <td class="cal-day wed"></td>
            <td class="cal-day thurs"></td>
            <td class="cal-day fri"></td>
            <td class="cal-day sat"></td>
          </tr>
        </tbody>
      </table>
    </div>
    <script>
    //set default month & year on page load
    var month = new Date().getMonth();
    var year = new Date().getFullYear();
    var monthOptions = document.getElementById('cal-month').getElementsByTagName("option");
    var yearOptions = document.getElementById('cal-year').getElementsByTagName("option");
    for (var i=0; i < monthOptions.length; i++){
        if(month = monthOptions[i].value){
            monthOptions[i].setAttribute("selected","selected");
        }
    }
    for (var i=0; i < yearOptions.length; i++){
        if(year == yearOptions[i].value){
            yearOptions[i].setAttribute("selected","selected");
        }
    }
    //builds default calendar
    buildCalendar();

    </script>
</body>
</html>
